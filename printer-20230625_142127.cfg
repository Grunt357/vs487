###Pandora P.004 - Manta m5p - CanBridge - Ebb36 v1.2###

##################
### MAIN FILES ###
##################

#[include mainsail.cfg]
[include macros.cfg]
[include software/sensorless.cfg]
#[include config_backup.cfg]
#[include ebbcan_G0B1_v1.2.cfg
[include btt36v11.cfg]
[include software/Adaptive_Purge.cfg]
[include software/Adaptive_Mesh.cfg]
[include software/nozzlewipe.cfg]
[include trad_rack.cfg]
[include trad_rack_optional.cfg]

[exclude_object]

###########################
### HARDWARE COMPONENTS ###
###########################
[include hardware/fans.cfg]
[include hardware/XY.cfg]
[include hardware/Z.cfg]
#[include hardware/heated_bed.cfg]
#[include hardware/probe.cfg]
[include hardware/temperature_sensors.cfg]
#[include hardware/stealthburner_leds.cfg]
#[include hardware/led_effects.cfg]

[virtual_sdcard]
path: /home/biqu/printer_data/gcodes

[display_status]

[mcu]
canbus_uuid: 6cb991e48d03

[mcu cbi]
serial: /tmp/klipper_host_mcu

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 3000
max_z_velocity: 75
max_z_accel: 3000
square_corner_velocity: 5.0

[extruder]
step_pin: can0:EXT_STEP
dir_pin: !can0:EXT_DIR
enable_pin: !can0:EXT_EN
rotation_distance: 22.22 #53.494165 #5.57 #26.72306036
gear_ratio: 50:10 
microsteps: 16
full_steps_per_rotation: 200 
max_extrude_only_distance: 1400.0
max_extrude_only_velocity: 75.0 
max_extrude_only_accel: 1500 
max_extrude_cross_section: 10
nozzle_diameter: 0.8 #0.400
filament_diameter: 1.750
heater_pin: can0:HE0
sensor_pin: can0:TH0
sensor_type: ATC Semitec 104GT-2 
pullup_resistor: 2200             
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
min_extrude_temp: 20 #170
min_temp: 0
max_temp: 270
pressure_advance: 0.025                                              
pressure_advance_smooth_time: 0.04

## EXTRUDER MOTOR
[tmc2209 extruder]
uart_pin: can0:EXT_UART
stealthchop_threshold: 0
run_current: 0.5 #0.3

[heater_bed]
heater_pin: PA5
sensor_type: Generic 3950
sensor_pin: PA0
smooth_time: 3.0
pwm_cycle_time: 0.01612
min_temp: 0
max_temp: 120
#control: pid                                                        
#pid_kp: 68.453
#pid_ki: 2.749
#pid_kd: 426.122

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[probe]

pin: ^can0:LIMIT_1 
x_offset: 0
y_offset: 0
#z_offset: 0
speed: 8
#lift_speed: 8
samples: 3
samples_result: median
sample_retract_dist: 5
samples_tolerance: 0.015
samples_tolerance_retries: 10

activate_gcode:
    {% set PROBE_TEMP = 150 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %}
[settling_probe]
settling_sample: True
#   Globally enable the throw-away settling sample. Default is 'False'.
#   Setting this to 'True' will enable the throw-away sample for all
#   commands/operations that perform Z probing (QGL, Z tilt, Bed Mesh,
#   Screw Tilt, etc.)

[bed_mesh]
speed: 200
horizontal_move_z: 3
mesh_min: 10,17
mesh_max: 110,110
probe_count: 5,5
relative_reference_index: 12
algorithm: lagrange

[homing_override]
axes: xyz
gcode:
	{% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}

	{% if home_all or 'X' in params %}
		_HOME_X
        
	{% endif %}
	
	{% if home_all or 'Y' in params %}
		_HOME_Y
	{% endif %}
	
	{% if home_all or 'Z' in params %}
		G90
		G0 X60 Y60 F15000													#<-!-!-!- Set to the position of your Z endstop
		G28 Z
		G1 Z10
	{% endif %}

[z_tilt]
z_positions:
    -22.6, -16.4
    60, 151.3
    120, -16.4
points:
    10, 17 #10, 10
    60, 110
    110, 17 #10
speed: 200
horizontal_move_z: 5
retries: 6
retry_tolerance: 0.0075

[idle_timeout]
# only turn off heaters and motors if the printer is not paused
gcode:
    {% if not printer.pause_resume.is_paused %}
        TURN_OFF_HEATERS
        M84
    {% endif %}

#[idle_timeout]
#timeout: 1800
#gcode:
#    TURN_OFF_HEATERS
#    SET_FAN_SPEED FAN=Nevermore SPEED=0    
#    M84
#    STATUS_OFF

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 22.765
#*# pid_ki = 1.275
#*# pid_kd = 101.590
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 61.732
#*# pid_ki = 1.524
#*# pid_kd = 625.037
#*#
#*# [probe]
#*# z_offset = -1.440
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.018750, -0.037500, -0.006250
#*# 	0.006250, 0.000000, -0.012500
#*# 	-0.018750, -0.025000, -0.006250
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 48.95
#*# max_x = 71.03
#*# min_y = 48.95
#*# max_y = 71.17
